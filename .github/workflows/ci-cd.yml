name: ðŸš€ CI/CD Pipeline - Test, Build & Deploy

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Job 1: Quick validation tests
  quick-validation:
    name: âš¡ Quick Validation
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸŒ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: âš¡ Quick Tests
        run: |
          echo "âš¡ Running quick validation tests..."
          
          # Test YAML files syntax
          echo "ðŸ“‹ Testing YAML files..."
          ruby -e "require 'yaml'; YAML.load_file('_config.yml')"
          ruby -e "require 'yaml'; YAML.load_file('_i18n/es.yml')"
          ruby -e "require 'yaml'; YAML.load_file('_i18n/en.yml')"
          
          # Test JavaScript syntax
          echo "ï¿½ Testing JavaScript..."
          if command -v node >/dev/null 2>&1; then
            node -c assets/js/main.js
          fi
          
          echo "âœ… Quick validation tests passed!"

  # Job 2: Jekyll setup and dependencies
  setup-dependencies:
    name: ðŸ“¦ Setup Dependencies
    runs-on: ubuntu-latest
    needs: quick-validation
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ’Ž Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'
          bundler-cache: false

      - name: ðŸ“¦ Install Dependencies
        run: |
          echo "ðŸ“¦ Installing bundle dependencies..."
          gem install bundler
          bundle config set --local deployment 'false'
          bundle config set --local path 'vendor/bundle'
          bundle config set --local without 'test development'
          bundle install --jobs 4 --retry 3

      - name: ðŸ”§ Validate Jekyll Setup
        run: |
          echo "ðŸ“¦ Testing bundle dependencies..."
          bundle list
          
          echo "ðŸ”§ Testing Jekyll configuration..."
          bundle exec jekyll doctor

      - name: ðŸ’¾ Cache Dependencies
        uses: actions/cache@v3
        with:
          path: vendor/bundle
          key: ${{ runner.os }}-gems-${{ hashFiles('**/Gemfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-gems-

  # Job 3: Build tests
  build-tests:
    name: ðŸ”¨ Build Tests
    runs-on: ubuntu-latest
    needs: setup-dependencies
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ’Ž Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'
          bundler-cache: false

      - name: ðŸ’¾ Restore Dependencies Cache
        uses: actions/cache@v3
        with:
          path: vendor/bundle
          key: ${{ runner.os }}-gems-${{ hashFiles('**/Gemfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-gems-

      - name: ðŸ“¦ Install Dependencies
        run: |
          gem install bundler
          bundle config set --local deployment 'false'
          bundle config set --local path 'vendor/bundle'
          bundle config set --local without 'test development'
          bundle install --jobs 4 --retry 3

      - name: ðŸ› ï¸ Development Build Test
        run: |
          echo "ðŸ› ï¸ Testing development build..."
          JEKYLL_ENV=development bundle exec jekyll build --verbose
          echo "âœ… Development build successful"

      - name: ðŸ­ Production Build Test
        run: |
          echo "ðŸ­ Testing production build..."
          rm -rf _site
          JEKYLL_ENV=production bundle exec jekyll build --verbose
          echo "âœ… Production build successful"

      - name: ðŸ” Validate Build Results
        run: |
          echo "ðŸ” Validating build results..."
          if [ -d "_site" ]; then
            site_size=$(du -sh _site | cut -f1)
            echo "ðŸ“Š Site size: $site_size"
            
            echo "ðŸ“ Generated structure:"
            find _site -type f -name "*.html" | head -20
            
            # Check if main files exist (flexible validation)
            required_files=(
              "_site/index.html"
              "_site/en/index.html" 
              "_site/assets/css/style.css"
              "_site/assets/js/main.js"
            )
            
            # Optional files (won't fail if missing)
            optional_files=(
              "_site/cv/index.html"
              "_site/cv.html"
              "_site/proyectos/index.html"
              "_site/proyectos.html"
              "_site/blog/index.html"
              "_site/blog.html"
              "_site/en/resume/index.html"
              "_site/en/resume.html"
              "_site/en/projects/index.html"
              "_site/en/projects.html"
              "_site/en/blog/index.html"
              "_site/en/blog.html"
            )
            
            # Check required files
            for file in "${required_files[@]}"; do
              if [ -f "$file" ]; then
                echo "âœ… $file exists"
              else
                echo "âŒ $file missing"
                exit 1
              fi
            done
            
            # Check optional files (won't fail)
            for file in "${optional_files[@]}"; do
              if [ -f "$file" ]; then
                echo "âœ… $file exists"
              else
                echo "âš ï¸ $file not found (checking alternative paths)"
              fi
            done
            
            echo "âœ… Build validation completed successfully"
          else
            echo "âŒ _site directory not found"
            exit 1
          fi

      - name: ðŸ“¦ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-test-artifacts
          path: _site/
          retention-days: 1

  # Job 4: Content validation
  content-validation:
    name: ðŸ“ Content Validation
    runs-on: ubuntu-latest
    needs: quick-validation
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸŒ Check Posts Translations
        run: |
          echo "ðŸ“ Running content validation..."
          
          # Check posts translations by date
          echo "ðŸŒ Checking post translations..."
          
          extract_date() {
            basename "$1" | grep -o '^[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}'
          }
          
          missing_translations=0
          for post in _posts/es/*.md; do
            if [ -f "$post" ]; then
              post_date=$(extract_date "$post")
              filename=$(basename "$post")
              
              en_files=(_posts/en/${post_date}-*.md)
              
              if [ -f "${en_files[0]}" ]; then
                en_filename=$(basename "${en_files[0]}")
                echo "âœ… Translation found: $filename â†’ $en_filename"
              else
                echo "âš ï¸ Missing translation for date $post_date: $filename"
              fi
            fi
          done
          
          echo "âœ… Content validation completed"

  # Job 5: Production build (only for main branch)
  production-build:
    name: ðŸ­ Production Build
    runs-on: ubuntu-latest
    needs: [build-tests, content-validation]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ’Ž Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'
          bundler-cache: false

      - name: ðŸ’¾ Restore Dependencies Cache
        uses: actions/cache@v3
        with:
          path: vendor/bundle
          key: ${{ runner.os }}-gems-${{ hashFiles('**/Gemfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-gems-

      - name: ðŸ“¦ Install Dependencies
        run: |
          gem install bundler
          bundle config set --local deployment 'false'
          bundle config set --local path 'vendor/bundle'
          bundle config set --local without 'test development'
          bundle install --jobs 4 --retry 3

      - name: ðŸ”§ Setup GitHub Pages
        id: pages
        uses: actions/configure-pages@v5

      - name: ðŸ­ Build for Production
        run: |
          echo "ðŸ­ Building for production deployment..."
          bundle exec jekyll build --baseurl "${{ steps.pages.outputs.base_path }}"
        env:
          JEKYLL_ENV: production

      - name: ðŸ“¦ Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3

  # Job 6: Deploy (only for main branch)
  deploy:
    name: ðŸš€ Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: production-build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: ðŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # Job 7: Post-deployment validation (only after deploy)
  post-deploy-validation:
    name: ðŸŒ Post-deploy Validation
    runs-on: ubuntu-latest
    needs: deploy
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ’Ž Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'
          bundler-cache: false

      - name: ðŸ“¦ Install Dependencies
        run: |
          gem install bundler
          bundle config set --local deployment 'false'
          bundle config set --local path 'vendor/bundle'
          bundle config set --local without 'test development'
          bundle install --jobs 4 --retry 3

      - name: â±ï¸ Wait for Deployment
        run: |
          echo "â±ï¸ Waiting for deployment to be available..."
          sleep 30

      - name: ðŸŒ Test Live Site
        run: |
          echo "ðŸŒ Validating deployed site..."
          
          # Test deployed site URLs
          echo "ðŸ”— Testing deployed URLs..."
          if [ -f "scripts/test.rb" ]; then
            ruby scripts/test.rb
          else
            echo "âš ï¸ Test script not found, running basic URL tests..."
            
            # Basic curl tests
            urls=(
              "https://l3onkers.github.io/"
              "https://l3onkers.github.io/en/"
              "https://l3onkers.github.io/cv"
              "https://l3onkers.github.io/blog"
              "https://l3onkers.github.io/assets/css/style.css"
            )
            
            for url in "${urls[@]}"; do
              status=$(curl -s -o /dev/null -w "%{http_code}" "$url")
              if [ "$status" = "200" ]; then
                echo "âœ… $url ($status)"
              else
                echo "âŒ $url ($status)"
              fi
            done
          fi

      - name: ðŸŽ‰ Success Summary
        run: |
          echo "## ðŸŽ‰ Deployment Completed Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Pipeline Jobs Completed:" >> $GITHUB_STEP_SUMMARY
          echo "- âš¡ Quick Validation" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¦ Setup Dependencies" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”¨ Build Tests" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“ Content Validation" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ­ Production Build" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸš€ Deploy to GitHub Pages" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŒ Post-deploy Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ **Live Site**: https://l3onkers.github.io" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
