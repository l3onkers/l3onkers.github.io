name: ðŸš€ CI/CD Pipeline - Test, Build & Deploy

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Job 1: Quick validation tests
  quick-validation:
    name: âš¡ Quick Validation
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸŒ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: âš¡ Quick Tests
        run: |
          echo "âš¡ Running quick validation tests..."
          
          # Test YAML files syntax
          echo "ðŸ“‹ Testing YAML files..."
          ruby -e "require 'yaml'; YAML.load_file('_config.yml')"
          ruby -e "require 'yaml'; YAML.load_file('_i18n/es.yml')"
          ruby -e "require 'yaml'; YAML.load_file('_i18n/en.yml')"
          
          # Test JavaScript syntax
          echo "ï¿½ Testing JavaScript..."
          if command -v node >/dev/null 2>&1; then
            node -c assets/js/main.js
          fi
          
          echo "âœ… Quick validation tests passed!"

  # Job 2: Jekyll setup and dependencies
  setup-dependencies:
    name: ðŸ“¦ Setup Dependencies
    runs-on: ubuntu-latest
    needs: quick-validation
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ’Ž Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'
          bundler-cache: false

      - name: ðŸ“¦ Install Dependencies
        run: |
          echo "ðŸ“¦ Installing bundle dependencies..."
          gem install bundler
          bundle config set --local deployment 'false'
          bundle config set --local path 'vendor/bundle'
          bundle config set --local without 'test development'
          bundle install --jobs 4 --retry 3

      - name: ðŸ”§ Validate Jekyll Setup
        run: |
          echo "ðŸ“¦ Testing bundle dependencies..."
          bundle list
          
          echo "ðŸ”§ Testing Jekyll configuration..."
          bundle exec jekyll doctor

      - name: ðŸ’¾ Cache Dependencies
        uses: actions/cache@v3
        with:
          path: vendor/bundle
          key: ${{ runner.os }}-gems-${{ hashFiles('**/Gemfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-gems-

  # Job 3: Build tests
  build-tests:
    name: ðŸ”¨ Build Tests
    runs-on: ubuntu-latest
    needs: setup-dependencies
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ’Ž Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'
          bundler-cache: false

      - name: ðŸ’¾ Restore Dependencies Cache
        uses: actions/cache@v3
        with:
          path: vendor/bundle
          key: ${{ runner.os }}-gems-${{ hashFiles('**/Gemfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-gems-

      - name: ðŸ“¦ Install Dependencies
        run: |
          gem install bundler
          bundle config set --local deployment 'false'
          bundle config set --local path 'vendor/bundle'
          bundle config set --local without 'test development'
          bundle install --jobs 4 --retry 3

      - name: ðŸ› ï¸ Development Build Test
        run: |
          echo "ðŸ› ï¸ Testing development build..."
          JEKYLL_ENV=development bundle exec jekyll build --verbose
          echo "âœ… Development build successful"

      - name: ðŸ­ Production Build Test
        run: |
          echo "ðŸ­ Testing production build..."
          rm -rf _site
          JEKYLL_ENV=production bundle exec jekyll build --verbose
          echo "âœ… Production build successful"

      - name: ðŸ” Validate Build Results
        run: |
          echo "ðŸ” Validating build results..."
          if [ -d "_site" ]; then
            site_size=$(du -sh _site | cut -f1)
            echo "ðŸ“Š Site size: $site_size"
            
            # Check if main files exist
            required_files=(
              "_site/index.html"
              "_site/en/index.html" 
              "_site/assets/css/style.css"
              "_site/assets/js/main.js"
              "_site/cv.html"
              "_site/proyectos.html"
              "_site/blog.html"
              "_site/en/resume.html"
              "_site/en/projects.html"
              "_site/en/blog.html"
            )
            
            for file in "${required_files[@]}"; do
              if [ -f "$file" ]; then
                echo "âœ… $file exists"
              else
                echo "âŒ $file missing"
                exit 1
              fi
            done
            
            # Validate that blog posts are generated
            es_posts=$(find _site/blog -name "index.html" 2>/dev/null | wc -l)
            en_posts=$(find _site/en/blog -name "index.html" 2>/dev/null | wc -l)
            echo "ðŸ“ Generated posts: $es_posts (ES) + $en_posts (EN) = $((es_posts + en_posts)) total"
            
            if [ $((es_posts + en_posts)) -lt 6 ]; then
              echo "âš ï¸ Warning: Expected at least 6 posts (3 ES + 3 EN), found $((es_posts + en_posts))"
            fi
            
            echo "âœ… Build validation completed successfully"
          else
            echo "âŒ _site directory not found"
            exit 1
          fi

      - name: ðŸ“¦ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-test-artifacts
          path: _site/
          retention-days: 1

  # Job 4: Content validation
  content-validation:
    name: ðŸ“ Content Validation
    runs-on: ubuntu-latest
    needs: quick-validation
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸŒ Check Posts Translations
        run: |
          echo "ðŸ“ Running content validation..."
          
          # Check posts translations by date
          echo "ðŸŒ Checking post translations..."
          
          extract_date() {
            basename "$1" | grep -o '^[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}'
          }
          
          missing_translations=0
          for post in _posts/es/*.md; do
            if [ -f "$post" ]; then
              post_date=$(extract_date "$post")
              filename=$(basename "$post")
              
              en_files=(_posts/en/${post_date}-*.md)
              
              if [ -f "${en_files[0]}" ]; then
                en_filename=$(basename "${en_files[0]}")
                echo "âœ… Translation found: $filename â†’ $en_filename"
              else
                echo "âš ï¸ Missing translation for date $post_date: $filename"
              fi
            fi
          done
          
          echo "âœ… Content validation completed"

  # Job 5: Production build (only for main branch)
  production-build:
    name: ðŸ­ Production Build
    runs-on: ubuntu-latest
    needs: [build-tests, enhanced-content-validation, html-accessibility-validation]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ’Ž Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'
          bundler-cache: false

      - name: ðŸ’¾ Restore Dependencies Cache
        uses: actions/cache@v3
        with:
          path: vendor/bundle
          key: ${{ runner.os }}-gems-${{ hashFiles('**/Gemfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-gems-

      - name: ðŸ“¦ Install Dependencies
        run: |
          gem install bundler
          bundle config set --local deployment 'false'
          bundle config set --local path 'vendor/bundle'
          bundle config set --local without 'test development'
          bundle install --jobs 4 --retry 3

      - name: ðŸ”§ Setup GitHub Pages
        id: pages
        uses: actions/configure-pages@v5

      - name: ðŸ­ Build for Production
        run: |
          echo "ðŸ­ Building for production deployment..."
          bundle exec jekyll build --baseurl "${{ steps.pages.outputs.base_path }}"
        env:
          JEKYLL_ENV: production

      - name: ðŸ“¦ Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3

  # Job 6: Deploy (only for main branch)
  deploy:
    name: ðŸš€ Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: production-build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: ðŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # Job 7: Post-deployment validation (only after deploy)
  post-deploy-validation:
    name: ðŸŒ Post-deploy Validation
    runs-on: ubuntu-latest
    needs: deploy
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ’Ž Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'
          bundler-cache: false

      - name: ðŸ“¦ Install Dependencies
        run: |
          gem install bundler
          bundle config set --local deployment 'false'
          bundle config set --local path 'vendor/bundle'
          bundle config set --local without 'test development'
          bundle install --jobs 4 --retry 3

      - name: â±ï¸ Wait for Deployment
        run: |
          echo "â±ï¸ Waiting for deployment to be available..."
          sleep 30

      - name: ðŸŒ Test Live Site
        run: |
          echo "ðŸŒ Validating deployed site..."
          
          # Test deployed site URLs
          echo "ðŸ”— Testing deployed URLs..."
          if [ -f "scripts/test.rb" ]; then
            ruby scripts/test.rb
          else
            echo "âš ï¸ Test script not found, running basic URL tests..."
            
            # Basic curl tests
            urls=(
              "https://l3onkers.github.io/"
              "https://l3onkers.github.io/en/"
              "https://l3onkers.github.io/cv.html"
              "https://l3onkers.github.io/blog.html"
              "https://l3onkers.github.io/proyectos.html"
              "https://l3onkers.github.io/en/resume.html"
              "https://l3onkers.github.io/en/projects.html"
              "https://l3onkers.github.io/en/blog.html"
              "https://l3onkers.github.io/assets/css/style.css"
              "https://l3onkers.github.io/assets/js/main.js"
            )
            
            for url in "${urls[@]}"; do
              status=$(curl -s -o /dev/null -w "%{http_code}" "$url")
              if [ "$status" = "200" ]; then
                echo "âœ… $url ($status)"
              else
                echo "âŒ $url ($status)"
              fi
            done
          fi

      - name: ðŸŽ‰ Deployment Success
        run: |
          echo "## ï¿½ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ **Live Site**: https://l3onkers.github.io" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

  # Job 8: HTML & Accessibility validation
  html-accessibility-validation:
    name: ðŸ” HTML & Accessibility Tests
    runs-on: ubuntu-latest
    needs: build-tests
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ“¦ Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-test-artifacts
          path: _site/

      - name: ðŸŒ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ðŸ“¦ Install HTML Testing Tools
        run: |
          npm install -g html-validate
          npm install -g pa11y

      - name: ðŸ” Validate HTML
        run: |
          echo "ðŸ” Validating HTML syntax..."
          find _site -name "*.html" -exec html-validate {} \;

      - name: â™¿ Test Accessibility
        run: |
          echo "â™¿ Testing accessibility..."
          # Serve site locally for testing
          python3 -m http.server 8000 --directory _site &
          SERVER_PID=$!
          sleep 5
          
          # Accessibility tests on main pages
          pa11y http://localhost:8000/ || true
          pa11y http://localhost:8000/blog.html || true
          pa11y http://localhost:8000/cv.html || true
          pa11y http://localhost:8000/en/ || true
          
          # Kill server
          kill $SERVER_PID

  # Job 9: Enhanced content validation
  enhanced-content-validation:
    name: ðŸ“ Enhanced Content Validation
    runs-on: ubuntu-latest
    needs: quick-validation
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ’Ž Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'
          bundler-cache: false

      - name: ðŸ“¦ Install YAML Tools
        run: |
          gem install yaml-lint
          gem install htmlbeautifier

      - name: ðŸ“‹ Enhanced YAML Validation
        run: |
          echo "ðŸ“‹ Validating YAML files with enhanced checks..."
          yaml-lint _config.yml
          yaml-lint _i18n/es.yml
          yaml-lint _i18n/en.yml
          
          # Validate frontmatter of posts
          for file in _posts/**/*.md; do
            if [ -f "$file" ]; then
              echo "Validating frontmatter: $file"
              head -20 "$file" | yaml-lint || echo "âš ï¸ Warning in $file"
            fi
          done

      - name: ðŸŒ Enhanced Translation Check
        run: |
          echo "ðŸŒ Enhanced translation verification..."
          
          extract_date() {
            basename "$1" | grep -o '^[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}'
          }
          
          missing_translations=0
          for post in _posts/es/*.md; do
            if [ -f "$post" ]; then
              post_date=$(extract_date "$post")
              filename=$(basename "$post")
              
              en_files=(_posts/en/${post_date}-*.md)
              
              if [ -f "${en_files[0]}" ]; then
                en_filename=$(basename "${en_files[0]}")
                echo "âœ… Translation found: $filename â†’ $en_filename"
              else
                echo "âŒ Missing translation for date $post_date: $filename"
                missing_translations=1
              fi
            fi
          done
          
          # Check reverse direction
          for post in _posts/en/*.md; do
            if [ -f "$post" ]; then
              post_date=$(extract_date "$post")
              filename=$(basename "$post")
              
              es_files=(_posts/es/${post_date}-*.md)
              
              if [ ! -f "${es_files[0]}" ]; then
                echo "âŒ Missing Spanish translation for date $post_date: $filename"
                missing_translations=1
              fi
            fi
          done
          
          if [ $missing_translations -eq 1 ]; then
            echo ""
            echo "ðŸ’¡ Tip: Each post must have its translation with the same date (YYYY-MM-DD)"
            echo "   Example: 2024-01-15-welcome.md â†” 2024-01-15-bienvenido.md"
            exit 1
          fi

      - name: ðŸ“ Check Required Files
        run: |
          echo "ðŸ“ Checking required files..."
          required_files=(
            "_config.yml"
            "index.html"
            "en/index.html"
            "_layouts/default.html"
            "_layouts/post.html"
            "assets/css/style.css"
            "assets/js/main.js"
            "robots.txt"
          )
          
          for file in "${required_files[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… $file"
            else
              echo "âŒ Missing: $file"
              exit 1
            fi
          done

  # Job 10: Performance testing
  performance-testing:
    name: ðŸš€ Performance Tests
    runs-on: ubuntu-latest
    needs: build-tests
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ“¦ Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-test-artifacts
          path: _site/

      - name: ðŸŒ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ðŸ“¦ Install Performance Tools
        run: |
          npm install -g lighthouse
          npm install --save-dev clean-css terser

      - name: ðŸ”„ Run Asset Minification
        run: |
          echo "ðŸ”§ Running asset minification..."
          if [ -f "package.json" ]; then
            npm install
            node scripts/minify.js || echo "Minification script not found, continuing..."
          fi

      - name: ðŸš€ Run Performance Tests
        run: |
          echo "ðŸš€ Running enhanced performance tests..."
          
          # Serve site locally
          python3 -m http.server 8000 --directory _site &
          SERVER_PID=$!
          sleep 5
          
          # Run Lighthouse for multiple pages
          echo "ðŸ” Testing homepage..."
          lighthouse http://localhost:8000/ \
            --output json \
            --output html \
            --output-path ./lighthouse-homepage \
            --chrome-flags="--headless --no-sandbox" \
            --preset="desktop" \
            --throttling-method="devtools" \
            --quiet || true
          
          echo "ðŸ” Testing blog page..."
          lighthouse http://localhost:8000/blog.html \
            --output json \
            --output html \
            --output-path ./lighthouse-blog \
            --chrome-flags="--headless --no-sandbox" \
            --preset="desktop" \
            --throttling-method="devtools" \
            --quiet || true
          
          # Extract and display scores
          echo "ðŸ“Š Performance Scores:"
          if [ -f "lighthouse-homepage.report.json" ]; then
            node -e "
              const report = JSON.parse(require('fs').readFileSync('lighthouse-homepage.report.json'));
              const scores = report.lhr.categories;
              console.log('Homepage Scores:');
              console.log('  Performance: ' + Math.round(scores.performance.score * 100));
              console.log('  Accessibility: ' + Math.round(scores.accessibility.score * 100));
              console.log('  Best Practices: ' + Math.round(scores['best-practices'].score * 100));
              console.log('  SEO: ' + Math.round(scores.seo.score * 100));
            " || true
          fi
          
          # Kill server
          kill $SERVER_PID

      - name: ðŸ“Š Upload Performance Reports
        uses: actions/upload-artifact@v4
        with:
          name: performance-reports
          path: |
            lighthouse-*.html
            lighthouse-*.json
          retention-days: 30

  # Job 11: Test Summary (always runs to show results)
  test-summary:
    name: ðŸ“Š Test Summary
    runs-on: ubuntu-latest
    needs: [quick-validation, setup-dependencies, build-tests, content-validation, enhanced-content-validation, html-accessibility-validation, performance-testing]
    if: always()
    steps:
      - name: ðŸ“Š Generate Test Results Summary
        run: |
          echo "## ðŸ§ª Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Job | Status | Description |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| âš¡ Quick Validation | ${{ needs.quick-validation.result == 'success' && 'âœ… Passed' || needs.quick-validation.result == 'failure' && 'âŒ Failed' || 'â­ï¸ Skipped' }} | YAML, JS syntax validation |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“¦ Setup Dependencies | ${{ needs.setup-dependencies.result == 'success' && 'âœ… Passed' || needs.setup-dependencies.result == 'failure' && 'âŒ Failed' || 'â­ï¸ Skipped' }} | Ruby, Bundle installation |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”¨ Build Tests | ${{ needs.build-tests.result == 'success' && 'âœ… Passed' || needs.build-tests.result == 'failure' && 'âŒ Failed' || 'â­ï¸ Skipped' }} | Jekyll dev/prod builds |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“ Content Validation | ${{ needs.content-validation.result == 'success' && 'âœ… Passed' || needs.content-validation.result == 'failure' && 'âŒ Failed' || 'â­ï¸ Skipped' }} | Post translations |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“ Enhanced Content | ${{ needs.enhanced-content-validation.result == 'success' && 'âœ… Passed' || needs.enhanced-content-validation.result == 'failure' && 'âŒ Failed' || 'â­ï¸ Skipped' }} | YAML lint, required files |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” HTML & Accessibility | ${{ needs.html-accessibility-validation.result == 'success' && 'âœ… Passed' || needs.html-accessibility-validation.result == 'failure' && 'âŒ Failed' || 'â­ï¸ Skipped' }} | HTML validation, pa11y |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸš€ Performance Tests | ${{ needs.performance-testing.result == 'success' && 'âœ… Passed' || needs.performance-testing.result == 'failure' && 'âŒ Failed' || 'â­ï¸ Skipped' }} | Lighthouse performance |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Overall status
          if [[ "${{ needs.quick-validation.result }}" == "success" && 
                "${{ needs.setup-dependencies.result }}" == "success" && 
                "${{ needs.build-tests.result }}" == "success" ]]; then
            echo "## ðŸŽ‰ Core Tests: All Passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âš ï¸ Core Tests: Some Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Event**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
