name: ðŸš€ CI/CD Pipeline - Test, Build & Deploy

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Complete pipeline: Test â†’ Build â†’ Deploy
  ci-cd-pipeline:
    name: ðŸ”„ Complete Pipeline
    runs-on: ubuntu-latest
    steps:
      # 1. SETUP
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ’Ž Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'
          bundler-cache: true

      - name: ðŸŒ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 2. QUICK VALIDATION TESTS
      - name: âš¡ Quick Validation Tests
        run: |
          echo "âš¡ Running quick validation tests..."
          
          # Test bundle dependencies
          echo "ðŸ“¦ Testing bundle dependencies..."
          bundle list
          
          # Test Jekyll configuration
          echo "ðŸ”§ Testing Jekyll configuration..."
          bundle exec jekyll doctor
          
          # Test YAML files syntax
          echo "ðŸ“‹ Testing YAML files..."
          ruby -e "require 'yaml'; YAML.load_file('_config.yml')"
          ruby -e "require 'yaml'; YAML.load_file('_i18n/es.yml')"
          ruby -e "require 'yaml'; YAML.load_file('_i18n/en.yml')"
          
          # Test JavaScript syntax
          echo "ðŸŸ¨ Testing JavaScript..."
          if command -v node >/dev/null 2>&1; then
            node -c assets/js/main.js
          fi
          
          echo "âœ… Quick validation tests passed!"

      # 3. JEKYLL BUILD TESTS
      - name: ðŸ”¨ Jekyll Build Tests
        run: |
          echo "ðŸ”¨ Testing Jekyll builds..."
          
          # Development build test
          echo "ðŸ› ï¸ Testing development build..."
          JEKYLL_ENV=development bundle exec jekyll build --verbose
          echo "âœ… Development build successful"
          
          # Clean for production build
          rm -rf _site
          
          # Production build test  
          echo "ðŸ­ Testing production build..."
          JEKYLL_ENV=production bundle exec jekyll build --verbose
          echo "âœ… Production build successful"
          
          # Validate build results
          echo "ðŸ” Validating build results..."
          if [ -d "_site" ]; then
            site_size=$(du -sh _site | cut -f1)
            echo "ðŸ“Š Site size: $site_size"
            
            # Check if main files exist
            required_files=(
              "_site/index.html"
              "_site/en/index.html" 
              "_site/assets/css/style.css"
              "_site/assets/js/main.js"
              "_site/cv/index.html"
              "_site/proyectos/index.html"
              "_site/blog/index.html"
              "_site/en/resume/index.html"
              "_site/en/projects/index.html"
              "_site/en/blog/index.html"
            )
            
            for file in "${required_files[@]}"; do
              if [ -f "$file" ]; then
                echo "âœ… $file exists"
              else
                echo "âŒ $file missing"
                exit 1
              fi
            done
          else
            echo "âŒ _site directory not found"
            exit 1
          fi

      # 4. CONTENT VALIDATION
      - name: ðŸ“ Content Validation
        run: |
          echo "ðŸ“ Running content validation..."
          
          # Check posts translations by date
          echo "ðŸŒ Checking post translations..."
          
          extract_date() {
            basename "$1" | grep -o '^[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}'
          }
          
          missing_translations=0
          for post in _posts/es/*.md; do
            if [ -f "$post" ]; then
              post_date=$(extract_date "$post")
              filename=$(basename "$post")
              
              en_files=(_posts/en/${post_date}-*.md)
              
              if [ -f "${en_files[0]}" ]; then
                en_filename=$(basename "${en_files[0]}")
                echo "âœ… Translation found: $filename â†’ $en_filename"
              else
                echo "âš ï¸ Missing translation for date $post_date: $filename"
              fi
            fi
          done
          
          echo "âœ… Content validation completed"

      # 5. SETUP PAGES (only for pushes to main, not PRs)
      - name: ðŸ”§ Setup GitHub Pages
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        id: pages
        uses: actions/configure-pages@v5

      # 6. PRODUCTION BUILD (only for pushes to main)
      - name: ðŸ­ Production Build
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          echo "ðŸ­ Building for production deployment..."
          rm -rf _site
          bundle exec jekyll build --baseurl "${{ steps.pages.outputs.base_path }}"
        env:
          JEKYLL_ENV: production

      # 7. UPLOAD ARTIFACT (only for pushes to main)
      - name: ðŸ“¦ Upload Build Artifact
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/upload-pages-artifact@v3

      # 8. DEPLOY TO GITHUB PAGES (only for pushes to main)
      - name: ðŸš€ Deploy to GitHub Pages
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        id: deployment
        uses: actions/deploy-pages@v4

      # 9. POST-DEPLOYMENT VALIDATION (only after deployment)
      - name: ðŸŒ Post-deployment Validation
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          echo "ðŸŒ Validating deployed site..."
          echo "â±ï¸ Waiting for deployment to be available..."
          sleep 30
          
          # Test deployed site URLs
          echo "ðŸ”— Testing deployed URLs..."
          if [ -f "scripts/test.rb" ]; then
            ruby scripts/test.rb
          else
            echo "âš ï¸ Test script not found, running basic URL tests..."
            
            # Basic curl tests
            urls=(
              "https://l3onkers.github.io/"
              "https://l3onkers.github.io/en/"
              "https://l3onkers.github.io/cv"
              "https://l3onkers.github.io/blog"
              "https://l3onkers.github.io/assets/css/style.css"
            )
            
            for url in "${urls[@]}"; do
              status=$(curl -s -o /dev/null -w "%{http_code}" "$url")
              if [ "$status" = "200" ]; then
                echo "âœ… $url ($status)"
              else
                echo "âŒ $url ($status)"
              fi
            done
          fi

      # 10. SUCCESS SUMMARY
      - name: ðŸŽ‰ Pipeline Success Summary
        if: success()
        run: |
          echo "## ðŸŽ‰ Pipeline Completed Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Completed Steps:" >> $GITHUB_STEP_SUMMARY
          echo "- Quick validation tests" >> $GITHUB_STEP_SUMMARY
          echo "- Jekyll build tests (dev & prod)" >> $GITHUB_STEP_SUMMARY
          echo "- Content validation" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event_name }}" = "push" ] && [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "- Production build" >> $GITHUB_STEP_SUMMARY
            echo "- Deployment to GitHub Pages" >> $GITHUB_STEP_SUMMARY
            echo "- Post-deployment validation" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŒ **Live Site**: https://l3onkers.github.io" >> $GITHUB_STEP_SUMMARY
          else
            echo "- PR validation (no deployment)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Event**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
