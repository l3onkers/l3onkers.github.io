name: ðŸ§ª Tests y ValidaciÃ³n

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

# Allow multiple concurrent test runs
concurrency:
  group: "tests-${{ github.ref }}"
  cancel-in-progress: true

jobs:
  # Test 1: Jekyll Build y ValidaciÃ³n
  jekyll-build:
    name: ðŸ”¨ Jekyll Build Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'
          bundler-cache: true

      - name: Setup Pages
        id: pages
        uses: actions/configure-pages@v5

      - name: Build with Jekyll (Development)
        id: build-dev
        run: |
          echo "ðŸ”¨ Building Jekyll site in development mode..."
          bundle exec jekyll build --baseurl "${{ steps.pages.outputs.base_path }}" --verbose
          echo "âœ… Development build completed successfully"
        env:
          JEKYLL_ENV: development

      - name: Build with Jekyll (Production)
        id: build-prod
        run: |
          echo "ðŸ”¨ Building Jekyll site in production mode..."
          bundle exec jekyll build --baseurl "${{ steps.pages.outputs.base_path }}" --verbose
          echo "âœ… Production build completed successfully"
        env:
          JEKYLL_ENV: production

      - name: Validate build results
        run: |
          echo "ðŸ” Validating build results..."
          if [ -d "_site" ]; then
            echo "âœ… _site directory exists"
            site_size=$(du -sh _site | cut -f1)
            echo "ðŸ“Š Site size: $site_size"
            
            # Check if main files exist
            required_files=("_site/index.html" "_site/assets/css/style.css" "_site/assets/js/main.js")
            for file in "${required_files[@]}"; do
              if [ -f "$file" ]; then
                echo "âœ… $file exists"
              else
                echo "âŒ $file missing"
                exit 1
              fi
            done
          else
            echo "âŒ _site directory not found"
            exit 1
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: jekyll-site
          path: _site/
          retention-days: 1

  # Test 2: ValidaciÃ³n HTML y Accesibilidad
  html-validation:
    name: ðŸ” HTML & Accessibility Tests
    runs-on: ubuntu-latest
    needs: jekyll-build
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: jekyll-site
          path: _site/

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install testing dependencies
        run: |
          npm install -g html-validate
          npm install -g pa11y
          npm install -g lighthouse
      - name: Validate HTML
        run: |
          echo "ðŸ” Validando HTML..."
          find _site -name "*.html" -exec html-validate {} \;
      - name: Test Accessibility
        run: |
          echo "â™¿ Testeando accesibilidad..."
          # Servir el sitio localmente para testing
          python3 -m http.server 8000 --directory _site &
          SERVER_PID=$!
          sleep 5
          
          # Test de accesibilidad en pÃ¡ginas principales
          pa11y http://localhost:8000/ || true
          pa11y http://localhost:8000/blog.html || true
          pa11y http://localhost:8000/cv.html || true
          pa11y http://localhost:8000/en/ || true
          
          # Matar el servidor
          kill $SERVER_PID
  # Test 3: ValidaciÃ³n de Contenido y Estructura
  content-validation:
    name: ðŸ“ Content & Structure Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'
          bundler-cache: true

      - name: Install test gems
        run: |
          gem install yaml-lint
          gem install htmlbeautifier
      - name: Validate YAML files
        run: |
          echo "ðŸ“‹ Validando archivos YAML..."
          yaml-lint _config.yml
          yaml-lint _i18n/es.yml
          yaml-lint _i18n/en.yml
          
          # Validar frontmatter de posts
          for file in _posts/**/*.md; do
            if [ -f "$file" ]; then
              echo "Validando frontmatter: $file"
              head -20 "$file" | yaml-lint || echo "âš ï¸ Warning in $file"
            fi
          done
      - name: Check posts translations
        run: |
          echo "ðŸŒ Verificando traducciones de posts..."
          
          # FunciÃ³n para extraer fecha del nombre del archivo
          extract_date() {
            basename "$1" | grep -o '^[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}'
          }
          
          # Verificar que cada post en espaÃ±ol tenga su traducciÃ³n en inglÃ©s por fecha
          missing_translations=0
          for post in _posts/es/*.md; do
            if [ -f "$post" ]; then
              post_date=$(extract_date "$post")
              filename=$(basename "$post")
              
              # Buscar archivo en inglÃ©s con la misma fecha
              en_files=(_posts/en/${post_date}-*.md)
              
              if [ -f "${en_files[0]}" ]; then
                en_filename=$(basename "${en_files[0]}")
                echo "âœ… TraducciÃ³n encontrada: $filename â†’ $en_filename"
              else
                echo "âŒ Falta traducciÃ³n para fecha $post_date: $filename"
                missing_translations=1
              fi
            fi
          done
          
          # Verificar tambiÃ©n al revÃ©s - posts en inglÃ©s que tengan traducciÃ³n al espaÃ±ol
          for post in _posts/en/*.md; do
            if [ -f "$post" ]; then
              post_date=$(extract_date "$post")
              filename=$(basename "$post")
              
              # Buscar archivo en espaÃ±ol con la misma fecha
              es_files=(_posts/es/${post_date}-*.md)
              
              if [ ! -f "${es_files[0]}" ]; then
                echo "âŒ Falta traducciÃ³n al espaÃ±ol para fecha $post_date: $filename"
                missing_translations=1
              fi
            fi
          done
          
          if [ $missing_translations -eq 1 ]; then
            echo ""
            echo "ðŸ’¡ Tip: Cada post debe tener su traducciÃ³n con la misma fecha (YYYY-MM-DD)"
            echo "   Ejemplo: 2024-01-15-welcome.md â†” 2024-01-15-bienvenido.md"
            exit 1
          fi
      - name: Check required files
        run: |
          echo "ðŸ“ Verificando archivos requeridos..."
          required_files=(
            "_config.yml"
            "index.html"
            "en/index.html"
            "_layouts/default.html"
            "_layouts/post.html"
            "assets/css/style.css"
            "assets/js/main.js"
            "robots.txt"
            ".htaccess"
          )
          
          for file in "${required_files[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… $file"
            else
              echo "âŒ Falta: $file"
              exit 1
            fi
          done
  # Test 4: Performance y Lighthouse
  performance-test:
    name: ðŸš€ Performance Tests
    runs-on: ubuntu-latest
    needs: jekyll-build
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: jekyll-site
          path: _site/

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Lighthouse
        run: npm install -g lighthouse

      - name: Run Lighthouse tests
        run: |
          echo "ðŸš€ Ejecutando tests de performance..."
          # Servir el sitio localmente
          python3 -m http.server 8000 --directory _site &
          SERVER_PID=$!
          sleep 5
          
          # Ejecutar Lighthouse
          lighthouse http://localhost:8000/ \
            --output html \
            --output-path ./lighthouse-report.html \
            --chrome-flags="--headless --no-sandbox" \
            --quiet || true
          
          # Matar el servidor
          kill $SERVER_PID
      - name: Upload Lighthouse report
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-report
          path: lighthouse-report.html
          retention-days: 7

  # Test Summary
  test-summary:
    name: ðŸ“Š Test Summary
    runs-on: ubuntu-latest
    needs: [jekyll-build, html-validation, content-validation, performance-test]
    if: always()
    steps:
      - name: Test Results Summary
        run: |
          echo "## ðŸ§ª Resumen de Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test | Estado |" >> $GITHUB_STEP_SUMMARY
          echo "|------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Jekyll Build | ${{ needs.jekyll-build.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| HTML Validation | ${{ needs.html-validation.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Content Validation | ${{ needs.content-validation.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Performance Test | ${{ needs.performance-test.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY